<!DOCTYPE html>        
<html>
<html lang="de">
<head>
  <title>Akku</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css">
</head>                  
<body>
  <div class="container">
    <h1 class="text-center text-success">LiFePo4-Akku</h1>
    <div class="table-responsive">
      <table class="table table-striped table-dark">
        <tbody>
          <tr><td>Kapazit채t</td><td><div class="row justify-content-end" id="capacity">#</div></td><td>Ah</td></tr>
          <tr><td>Ladung abs.</td><td><div class="row justify-content-end" id="charge">#</div></td><td>Ah</td></tr>
          <tr><td>Ladung rel.</td><td><div class="row justify-content-end" id="charge_rel">#</div></td><td>%</td></tr>
          <tr><td>Spannung</td><td><div class="row justify-content-end" id="voltage">#</div></td><td>V</td></tr>
          <tr><td>Strom</td><td><div class="row justify-content-end" id="current">#</div></td><td>A</td></tr>
          <tr><td>Leistung</td><td><div class="row justify-content-end" id="power">#</div></td><td>W</td></tr>
          <tr><td>Zelle 1</td><td><div class="row justify-content-end" id="cell1">#</div></td><td>V</td></tr>
          <tr><td>Zelle 2</td><td><div class="row justify-content-end" id="cell2">#</div></td><td>V</td></tr>
          <tr><td>Zelle 3</td><td><div class="row justify-content-end" id="cell3">#</div></td><td>V</td></tr>
          <tr><td>Zelle 4</td><td><div class="row justify-content-end" id="cell4">#</div></td><td>V</td></tr>
          <tr><td>Temperatur</td><td><div class="row justify-content-end" id="temperature">#</div></td><td>째C</td></tr>
          <tr>
            <td>Fehler</td>
            <td colspan=2><div class="row justify-content-center" id="error">#</div></td>
          </tr>
          <tr>
            <td><button id="on" type="button" class="btn btn-success btn-block btn-lg"><small>Akku Ein</small></button></td>
            <td colspan=3><button id="off" type="button" class="btn btn-danger btn-block btn-lg"><small>Akku Aus</small></button></td>
          </tr>
          <tr>
            <td colspan=1><button id="reset" type="button" class="btn btn-primary btn-block btn-lg"><small>Akku Reset</small></button></td>
            <td colspan=2><button id="ack" type="button" class="btn btn-warning btn-block btn-lg"><small>Fehler Reset</small></button></td>
          </tr>
          <tr><td colspan=3><button id="shutdown" type="button" class="btn btn-dark btn-block btn-lg"><small>WLAN herunterfahren</small></button></td></tr>
          <tr><td colspan=3><button onclick="window.location.href='settings.html'" id="settings" type="button" class="btn btn-dark btn-block btn-lg"><small>Einstellungen / Internet</small></button></td></tr>
          <tr><td colspan=3><button onclick="window.location.href='/graph'" id="settings" type="button" class="btn btn-dark btn-block btn-lg"><small>Statistiken</small></button></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="text/javascript">
  function update() {
    fetch('/api/aktuelle_werte').then(function(response) {return response.json();}).then(function(myJson) {
        document.getElementById('capacity').innerText = myJson["capacity"].toFixed(0);
        document.getElementById('charge').innerText = myJson["charge"].toFixed(0);
        document.getElementById('charge_rel').innerText = myJson["charge_rel"].toFixed(0);
        document.getElementById('voltage').innerText = myJson["voltage"].toFixed(2);
        current = myJson["current"].toFixed(2);
        if (current > -0.9 & current < 0.9) {current = 0.0};
        document.getElementById('current').innerText = current;
        if (current == 0) { document.getElementById('power').innerText = 0} else {
          document.getElementById('power').innerText = myJson["power"].toFixed(2);
        }
        document.getElementById('cell1').innerText = myJson["cell_voltages"][0].toFixed(2);
        document.getElementById('cell2').innerText = myJson["cell_voltages"][1].toFixed(2);
        document.getElementById('cell3').innerText = myJson["cell_voltages"][2].toFixed(2);
        document.getElementById('cell4').innerText = myJson["cell_voltages"][3].toFixed(2);
        document.getElementById('temperature').innerText = myJson["temperature"].toFixed(1);
        document.getElementById('error').innerText = myJson["errors"];
        // charge.refresh(myJson["charge"].toFixed(0), myJson["capacity"].toFixed(0), 0);
        // voltage.refresh(myJson["voltage"].toFixed(2), 14, 0);
    })
  }
  </script>


  <script type="text/javascript">
  // update all 10000 ms
  (function() {update(); setInterval(function() {update();}, 1000);}())
  </script>

  <script type="text/javascript">
  function cancel_timer(eve) {
    if (typeof on_timeout !== 'undefined') {
      clearTimeout(on_timeout);
    };
  }

  function register_event(endpoint, elementid, msg_ok_title, msg_ok_text, msg_error, timeout) {
	  function do_action(event) {
		  on_timeout = setTimeout(function() {
			  fetch(endpoint, {"method": "POST"}).then(function(response) {
				  return response.json();
			  }).then(function(myJson) {
				  if (myJson["success"] == true) {
					  console.log(msg_ok_title + "\n" + msg_ok_text);
					  swal(msg_ok_title, msg_ok_text);
				  } else {
					  console.log(msg_error);
					  swal(msg_error);
				  };
			  });
		  }, timeout);
	  };
	  on_button = document.getElementById(elementid);
	  on_button.addEventListener('mousedown', do_action);
	  on_button.addEventListener('touchstart', do_action);
	  on_button.addEventListener('touchend', cancel_timer);
	  on_button.addEventListener('mouseup', cancel_timer);
  };


  register_event("/api/on", "on", "Akku wird eingeschaltet", "", "Kein Erfolg", 2000);
  register_event("/api/off", "off", "Akku wurde ausgeschaltet", "", "Kein Erfolg", 2000);
  register_event("/api/reset", "reset", "Akku wurde zur체ckgesetzt.", "", "Kein Erfolg", 5000);
  register_event("/api/ack", "ack", "Fehler wurde quittiert.", "", "Kein Erfolg", 1000);
  register_event("/api/shutdown", "shutdown", "WLAN-Modul wird heruntergefahren.", "Die WLAN-Verbindung wird abgebrochen.\n\nZum Starten des WLAN-Moduls, den Knopf erneut dr체cken.", "Kein Erfolg", 5000);
  </script>

  <script src="/vendor/jquery/jquery-3.3.1.slim.min.js"></script>
  <script src="/vendor/popper/popper.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="/vendor/sweetalert/sweetalert.min.js"></script>
</body>
</html>
